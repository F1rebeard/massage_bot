import logging

from aiogram import Dispatcher
from aiogram.types import Message, CallbackQuery
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

from keyboards.main_menu import user_menu, admin_menu
from keyboards.user_kb import (
    service_inline_keyboard,
    get_service_info,
    extra_service_inline_keyboard,
    backward_button
)
from calendar.calendar import MassageCalendar, calendar_callback
from create_bot import bot, db
from constants import ADMIN_IDS, MASSAGES, OTHER_SERVICE, EXTRA_SERVICE


async def cancel_state(state: FSMContext) -> None:
    """
    Cancel the FSMContext machine state.
    :param state:
    :return: None
    """
    current_state = await state.get_state(state)
    if current_state is not None:
        await state.finish()
    else:
        pass


class UserActions(StatesGroup):
    choose_date = State()
    choose_service = State()
    gift_certificate = State()


async def start_bot(message: Message, state: FSMContext):
    """
    Start the bot and check_
    :param message:
    :param state:
    :return:
    """
    telegram_id = message.from_user.id
    await cancel_state(state)
    if telegram_id in ADMIN_IDS:
        await message.answer(
            text='–ü—Ä–∏–≤–µ—Ç, –∫–æ–ª–ª–µ–≥–∞ {message.from_user.first_name}',
            reply_markup=admin_menu
        )
    elif await db.get_user_by_id(telegram_id) is None:
        # add new user to database!
        await message.answer(
            text='–ü—Ä–∏–≤–µ—Ç! –£ –Ω–∞—Å –∑–¥–µ—Å—å –≤–ø–µ—Ä–≤—ã–µ, —è –ø–æ–º–æ–≥–∞—é –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞—Å—Å–∞–∂ üòä'
                 '–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã üòâ',
            reply_markup=user_menu
        )
    else:
        await message.answer(
            text='–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ —Å–Ω–æ–≤–∞ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è üòé\n\n'
                 '–•–æ—á–µ—à—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞—Å—Å–∞–∂?',
            reply_markup=user_menu
        )


async def show_all_services(message: Message, state: FSMContext):
    """
    Show up a menu with massage types for user.
    :param message:
    :param state:
    :return:
    """
    await cancel_state(state)
    await message.answer(
        '–í—ã–±–µ—Ä–∏—Ç–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —É—Å–ª—É–≥—É üòä',
        reply_markup=service_inline_keyboard()
    )
    await state.set_state(UserActions.choose_service)


async def choose_service(query: CallbackQuery, state: FSMContext):
    """
    Choose a service by user.
    :param query:
    :param state:
    :return:
    """
    async with state.proxy() as data:
        if query.data == 'gift_certificate':
            data['selected_service'] = '–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'
            await query.message.edit_text(
                '–ú–æ–∂–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç üéÅ –Ω–∞ –ª—é–±—É—é —Å—É–º–º—É –∏–ª–∏'
                '–Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ–¥—É—Ä. –ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'
                ' –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã üòâ?'
            )
            await state.set_state(UserActions.gift_certificate)
        elif query.data in set(MASSAGES.keys()):
            name, time, price = get_service_info(MASSAGES, query.data)
            basic_text = (f'–í—ã –≤—ã–±—Ä–∞–ª–∏ {name}, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é {time} –º–∏–Ω.\n'
                          f'C—Ç–æ–∏–º–æ—Å—Ç—å: {price} —Ä—É–±.\n\n')
            if query.data in ('general', 'back_and_legs', 'hands_and_neck'):

                await query.message.edit_text(
                    text=basic_text + f'–¢–∞–∫ –∂–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å'
                                      f' –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:',
                    reply_markup=extra_service_inline_keyboard()
                )
            elif query.data == '4_hands':
                await query.message.edit_text(
                    text=basic_text + f'–¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Å—Å–∞–∂–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–µ '
                                f'–≤—Ä–µ–º—è –¥–ª—è –¥–≤—É—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.'
                                f' –í–û–ó–ú–û–ñ–ù–û –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–ê–Ø –°–í–Ø–ó–¨ C –ú–ê–°–°–ê–ñ–ò–°–¢–û–ú'
                                f' –£–¢–û–ß–ù–ò–¢–¨ –ë–´!',
                    reply_markup=await MassageCalendar().start_calendar()
                )
            else:
                await query.message.edit_text(
                    text=basic_text,
                    reply_markup=await MassageCalendar().start_calendar()
                )
        elif query.data in set(OTHER_SERVICE.keys()):
            name, time, price = get_service_info(OTHER_SERVICE, query.data)
            basic_text = (f'–í—ã –≤—ã–±—Ä–∞–ª–∏ {name}, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é {time} –º–∏–Ω.\n'
                          f'C—Ç–æ–∏–º–æ—Å—Ç—å: {price} —Ä—É–±.\n\n')
            await query.message.edit_text(
                text=basic_text,
                reply_markup=await MassageCalendar().start_calendar()
            )










async def show_calendar_for_user(message: Message, state: FSMContext):
    """
    Shows calendar for user to book the massage session.
    :param message:
    :param state:
    :return:
    """
    await message.answer(
        text='–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–∞—Å—Å–∞–∂:\n –°–ª–æ–≤–∞ –æ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–µ, –µ—Å—Ç—å/–Ω–µ—Ç'
             '–∑–∞–ø–∏—Å–∏',
        reply_markup=await MassageCalendar().start_calendar()
    )
    await state.set_state(UserActions.choose_date)


async def check_active_sessions_for_user(message: Message, state: FSMContext):
    """

    :param message:
    :param state:
    :return:
    """
    await cancel_state(state)
    telegram_id = message.from_user.id
    # GET ACTIVE SESSIONS FOR USER BY ID
    await message.answer(
        text='–¢–£–¢ –ó–ê–ü–ò–°–¨ –û –ú–ê–°–°–ê–ñ–ï',
        # –ö–ù–û–ü–ö–ê –û–¢–ú–ï–ù–´ –ï–õ–°–ò –í–†–ï–ú–Ø –ï–©–Å –ü–û–ó–í–û–õ–Ø–ï–¢
    )


async def ask_about_massage(message: Message, state: FSMContext):
    """

    :param message:
    :param state:
    :return:
    """
    await cancel_state()
    await message.answer(
        '–û—Ç–≤–µ—á–∞—é –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ '
        '–æ—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ—Ç –º–∞—Å—Ç–µ—Ä–∞ —Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–º–∏'
        ' –≤–∞—Å –≤–æ–ø—Ä–æ—Å–∞–º–∏'
    )


def register_user_handlers(dp: Dispatcher):
    dp.register_message_handler(
        start_bot,
        commands=['start',],
        state='*'
    )
    dp.register_message_handler(
        show_all_services,
        text='–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –º–∞—Å—Å–∞–∂ üíÜ‚Äç‚ôÇ',
        state='*'
    )